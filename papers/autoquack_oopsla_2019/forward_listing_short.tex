\newcommand{\finf}{finf}
\newcommand{\tinf}{tinf}
\newcommand{\out}{out}
\newcommand{\braces}[1]{\left\{\!\!\!\begin{array}{l@{}} #1 \end{array}\right\}}
\newcommand{\ga}{\gamma}
\newcommand{\Eg}{E_\ga}
\newcommand{\Vg}{V_\ga}

\begin{figure*}[!ht]
\vspace{-1ex}
  \begin{lstlisting}[multicols=2]
$//$$\braces{\forall \ga, \m{\finf}, \m{\tinf}, \m{\out}, \m{from}, \m{to}, \m{v}, \m{n}.~ \null \\ \p{gc{\_}graph}(\ga) * \p{\finf}(\m{\finf}, \m{fi}) * \p{\tinf}(\m{\tinf}, \m{ti}) /| \null \\ \m{compat}(\ga, \m{\finf}, \m{\tinf}, \m{\out}, \m{from}, \m{to}) /| \null \\ \tx{s} = \m{start}(\ga, \m{from}) /| \tx{l} = \tx{s} + \m{size}(\ga, \m{from}) /| \null \\ \tx{n} = \m{naddr}(\m{\tinf}, \m{to}) /| \tx{p} = \m{vaddr}(\ga, \m{v}) + \m{n}} \alpha$
void forward (value *s, *l, **n, *p, 
              int depth) {
 value * v; value va = *p; 
 if(Is_block(va)) $// \textit{is ptr}$
  v = (value*)iop2p(va); 
  if(Is_from(s, l, v)) {$// \textit{in from}$
$//$$\braces{\alpha /| \tx{v} = \m{v'} /| \exists \m{e}, {v'}.~ e \in \Eg /| (\ga, \m{v})[\m{n}] = \m{e} /| \null \\ \m{dst}(\gamma, \m{e}) = \m{v'} /| \m{v} |-> \m{v'}} \beta $
$//$$\searrow$$\braces{\exists \m{flds}, \m{hdr}.~\m{flds} = (\ga, \m{v'}) /| \null \\ \m{hdr} = \m{flds}[-1] /| \m{v'} |-> \m{flds}} \gamma $
   header_t hd = Hd_val(v);
$//$$\braces{\beta /| \tx{hd} = \m{val}(\m{hdr})}$ $\swarrow$ $\braces{\gamma /| \tx{hd} = \m{val}(\m{hdr})}$
   if(hd == 0) { $// \textit{already forwarded}$
$//$$\searrow \left\{\!\!\!\begin{array}{l@{}} \exists \m{hd'},\m{flds'}.~ \m{hd'} = \m{mkhd}(\ga, \m{v'}) /| \m{flds'} = \m{mkfv}(\ga, \m{v'}) /| \null \\ \m{v'} |-> \m{hd'},\m{flds'} /| \m{flds'}[0] = \m{vaddr}(\m{copvert}(\ga, \m{v'})) \end{array}\right\}$
    *p = Field(v,0);
   } else {
$//$remind them of old facts...
$//$$\{ \tx{hd} = \m{Z2val}(\m{hd'})\}$
    int i; int sz; value *new;
    sz = size(hd); new = *n+1; *n = new+sz;
$//$$\{\tx{sz} = \m{getvertsz}(\m{hd'}) = \m{lenflds}(\ga, \m{v'}) /| \tx{new} = \m{sp\_start}(\m{to}) + \m{used}(\m{to}) + 1 /| \tx{??}\}$        
    Hd_val(new) = hd; $//$ ??
    for(i = 0; i < sz; i++) 
     Field(new, i) = Field(v, i);
    Hd_val(v) = 0;
    Field(v, 0) = p2iop((void *)new);
$//$$\searrow$
    *p = p2iop((void *)new);
$//$$\swarrow$
} } } }
$//$$\{\exists \m{e}, \m{v'}, \m{b}, \m{i}.~ \tx{va} = \m{flds}[\m{e}] = \m{vaddr}(\ga, \m{dst}(\ga, \m{e})) = \m{vaddr}(\ga, \m{v'}) = \m{Vptr}(\m{b},\m{i})\}$

\end{lstlisting}
\vspace{-0.4em}
\caption{Clight code and proof sketch for forward}
\label{fig:forward}
\vspace{-1em}
\end{figure*}

