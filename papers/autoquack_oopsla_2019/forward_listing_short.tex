\newcommand{\finf}{finf}
\newcommand{\tinf}{tinf}
\newcommand{\out}{out}
\newcommand{\braces}[1]{\left\{\!\!\!\begin{array}{l@{}} #1 \end{array}\right\}}
\newcommand{\ga}{\gamma}
\newcommand{\Eg}{E_\ga}
\newcommand{\Vg}{V_\ga}

\begin{figure*}[!ht]
\vspace{-1ex}
  \begin{lstlisting}[multicols=2]
$//$$\braces{\forall \ga, \m{\finf}, \m{\tinf}, \m{from}, \m{to}, \m{v}, \m{n}.~\null \\ \p{gc{\_}graph}(\ga) * \p{\finf}(\m{\finf}) * \p{\tinf}(\m{\tinf}) /| \null \\ \m{compat}(\ga, \m{\finf}, \m{\tinf}, \m{from}, \m{to}) /| \null \\ \tx{s} = \m{start}(\ga, \m{from}) /| \tx{l} = \tx{s} + \m{gensize}(\ga, \m{from}) /| \null \\ \tx{n} = \m{naddr}(\m{\tinf}, \m{to}) /| \tx{p} = \m{vaddr}(\ga, \m{v}) + \m{n}} \defeq \phi_1 $
void forward (value *s, *l, **n, *p, 
              int depth) {
 value * v; value va = *p; 
 if(Is_block(va)) {$// \textit{is ptr}$
  v = (value*)iop2p(va); 
  if(Is_from(s, l, v)) {$ // \textit{in from}$
$//$$\braces{\phi_1 /| \exists \m{e}, \m{v'}.~\m{lab}(\ga, \m{v})[\m{n}] = \m{e} /| \null \\ \m{dst}(\ga, \m{e}) = \m{v'} /| \tx{v} = \m{vaddr}(\ga, \m{v'})} \phi_8 $
$//$$\searrow$$\braces{\exists \m{flds'}, \m{hdr'}.~\m{flds'} = \m{lab}(\ga, \m{v'}) /| \null \\ \m{v'} |-> \m{flds'} /| \m{hdr'} = \m{flds'}[-1]} \gamma $
   header_t hd = Hd_val(v);
$//$$\swarrow$$\braces{\gamma /| \tx{hd} = \m{val}(\m{hdr'})}$
$//$$\braces{\beta /| \tx{hd} = \m{val}(\m{hdr'})}$ 
   if(hd == 0) {$// \textit{already forwarded}$
$//$$\braces{\beta /| \tx{hd} = 0} \delta $ 
$//$$\searrow$$\braces{\exists \m{flds}, \m{flds'}.~\m{v} |-> \m{flds} /| \m{v'} |-> \m{flds'} /| \null \\ \m{flds} = \m{lab}(\ga, \m{v}) /| \m{flds'} = \m{lab}(\ga, \m{v'}) /| \null \\ \m{flds'}[0] = \m{vaddr}(\gamma, \m{copy}(\ga, \m{v'})) /| \tx{p} = \tx{\&}\m{flds}[n]} \epsilon $
    *p = Field(v,0);
$//$$\swarrow$$\braces{\epsilon /| \m{flds}[n] := \m{flds'}[0]}$
$//$$\braces{\exists \ga'.~\p{gc{\_}graph}(\ga') /| \ga' = \m{upd\_edge}(\ga, \m{e}, \m{copy}(\ga, \m{v'})) /| \null \\ \m{postcondition}(\ga', \m{\tinf}, \m{\finf})}$
   } else {$// \textit{not yet forwarded}$
$//$$\braces{\beta /| \tx{hd} \neq 0} \zeta $
    int i; int sz; value *new;
    sz = size(hd); new = *n+1; *n = new+sz;
$//$$\braces{\zeta /| \tx{sz} = \m{blocksize}(\tx{hd}) /| \null \\ \tx{new} = \m{start}(\gamma,\m{to}) + \m{used}(\gamma, \m{to}) + 1 /| \tx{n} = \tx{new} + \tx{sz}} \eta $      
    Hd_val(new) = hd; 
    for(i = 0; i < sz; i++) 
     Field(new, i) = Field(v, i);
$//$$\braces{\exists \ga', \m{v''}, \m{\tinf'}.~\p{gc\_graph}(\ga') /| \null \\ 
\m{v''} = \m{newly\_copied\_vert(\ga, \m{to})} /| \null \\ \ga' = \m{copy\_block}(\gamma, \m{to}, \m{v'}, \m{v''}) /| \null \\ 
\m{compat}(\ga', \m{\finf}, \m{\tinf'}, \m{from}, \m{to})} \theta $
    Hd_val(v) = 0;
    Field(v, 0) = p2iop((void *)new);
$//$$\braces{\theta /| \m{val}(\m{hdr'}) = 0 /| \m{flds'}[0] = \m{copy}(\ga, \m{v'})} \m{\color{red}check} $
$//$$\searrow$$\braces{\exists \m{flds}.~\m{v} |-> \m{flds} /| \m{flds} = \m{lab}(\ga', \m{v})}$
    *p = p2iop((void *)new);
$//$$\swarrow$$\braces{\m{flds}[0] := \m{vaddr}(\ga, \m{v''})}$
$//$$\braces{\exists \ga''.~\p{gc\_graph}(\ga'') /| \ga'' = \m{upd\_edge}(\ga', \m{e}, \m{v''})}$
}}}}
$//$$\braces{\m{postcondition}(\gamma'', \m{tinf'}, \m{finf})}$
\end{lstlisting}
\vspace{-0.4em}
\caption{Clight code and proof sketch for forward}
\label{fig:forward}
\vspace{-1em}
\end{figure*}

